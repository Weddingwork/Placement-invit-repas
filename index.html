<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Table Mariage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffeef8 0%, #e6f3ff 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #98A4C9 0%, #7a89b8 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            margin-bottom: 15px;
        }
        
        .couple-names {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
        }
        
        .couple-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .couple-input-group input {
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
            text-align: center;
            min-width: 150px;
        }
        
        .gender-toggle {
            display: flex;
            gap: 5px;
        }
        
        .gender-toggle button {
            padding: 5px 10px;
            border: 2px solid white;
            border-radius: 5px;
            background: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .gender-toggle button:hover {
            background: white;
            transform: scale(1.1);
        }
        
        .gender-toggle button.active {
            background: white;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        
        .couple-names span {
            font-size: 20px;
            font-weight: bold;
        }
        
        /* Espaces de repas */
        .space-selector {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 3px solid #98A4C9;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .space-btn {
            padding: 15px 30px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 200px;
        }
        
        .space-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .space-btn.active {
            background: #98A4C9;
            color: white;
            border-color: #7a89b8;
            box-shadow: 0 5px 20px rgba(152,164,201,0.4);
        }
        
        .space-btn .space-name {
            font-size: 18px;
        }
        
        .space-btn .space-size {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .space-btn .space-stats {
            font-size: 11px;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .space-info-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.98);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 12px;
            z-index: 100;
        }
        
        .space-info-overlay h3 {
            margin-bottom: 8px;
            color: #98A4C9;
        }
        
        .diet-info {
            font-size: 10px;
            color: #00ff00;
            font-weight: bold;
            margin-top: 5px;
            text-align: center;
            line-height: 1.2;
        }
        
        .allergy-info {
            font-size: 10px;
            color: #ff0000;
            font-weight: bold;
            margin-top: 3px;
            text-align: center;
            line-height: 1.2;
        }
        
        .toolbar {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #98A4C9;
            color: white;
        }
        
        .btn-primary:hover {
            background: #7a89b8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .table-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .table-selector select {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            font-size: 14px;
        }
        
        .main-content {
            display: flex;
            height: calc(100vh - 250px);
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #fafafa;
        }
        
        #canvas {
            position: relative;
            min-width: 2000px;
            min-height: 1500px;
            background-image: 
                linear-gradient(rgba(200,200,200,.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200,200,200,.2) 1px, transparent 1px);
            background-size: 50px 50px;
            border: 4px solid #98A4C9;
            box-shadow: inset 0 0 0 2px rgba(152,164,201,0.3);
        }
        
        .table {
            position: absolute;
            cursor: move;
            background: white;
            border: 3px solid #98A4C9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #98A4C9;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: box-shadow 0.3s;
        }
        
        .table:hover {
            box-shadow: 0 6px 25px rgba(152,164,201,0.4);
        }
        
        .table.selected {
            border-color: #7a89b8;
            box-shadow: 0 0 0 4px rgba(152,164,201,0.3);
        }
        
        .table-round {
            border-radius: 50%;
        }
        
        .table-rect {
            border-radius: 10px;
        }
        
        .table-rect6 {
            border-radius: 10px;
        }
        
        .table-rect8 {
            border-radius: 10px;
        }
        
        .table-label {
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s;
            line-height: 1.4;
        }
        
        .table-label:hover {
            background: rgba(152,164,201,0.1);
        }
        
        .table-info {
            font-size: 11px;
            color: #6c757d;
            margin-top: 3px;
            font-weight: normal;
        }
        
        .seat {
            position: absolute;
            min-width: 80px;
            padding: 8px 12px;
            background: #fff;
            border: 2px solid #6c757d;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .seat:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }
        
        .seat.assigned {
            background: #28a745;
            border-color: #28a745;
            color: white;
            font-weight: 600;
        }
        
        .seat.assigned.side-left {
            background: #ffc0cb;
            border-color: #ff91a4;
            color: #333;
        }
        
        .seat.assigned.side-right {
            background: #87ceeb;
            border-color: #5dade2;
            color: #333;
        }
        
        .seat.assigned.gender-girl {
            background: #ffc0cb;
            border-color: #ff91a4;
            color: #333;
        }
        
        .seat.assigned.gender-boy {
            background: #87ceeb;
            border-color: #5dade2;
            color: #333;
        }
        
        .seat.assigned.gender-other {
            background: #90ee90;
            border-color: #5cb85c;
            color: #333;
        }
        
        .seat.assigned.provider {
            background: #9e9e9e;
            border-color: #757575;
            color: white;
        }
        
        .seat.assigned.has-diet {
            background: #ffeb3b !important;
            border-color: #fbc02d !important;
            color: #000 !important;
        }
        
        .seat.assigned.has-both {
            background: #f44336 !important;
            border-color: #d32f2f !important;
            color: #00ff00 !important;
        }
        
        .sidebar {
            width: 350px;
            background: #f8f9fa;
            border-left: 2px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }
        
        .sidebar h3 {
            margin-bottom: 15px;
            color: #98A4C9;
        }
        
        .guest-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .guest-input input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .guest-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .guest-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #e9ecef;
            border-radius: 5px;
            cursor: grab;
            transition: all 0.3s;
            user-select: none;
        }
        
        .guest-item:not(.assigned) {
            color: #dc3545;
            font-weight: 600;
            border-left: 4px solid #dc3545;
        }
        
        .guest-item:active {
            cursor: grabbing;
        }
        
        .guest-item:hover {
            background: #dee2e6;
            transform: translateX(5px);
        }
        
        .guest-item.assigned {
            background: #d4edda;
            border-left: 4px solid #28a745;
            cursor: pointer !important;
            pointer-events: auto !important;
        }
        
        .guest-item.assigned:hover {
            background: #c3e6cb;
            transform: translateX(5px);
        }
        
        .guest-item.dragging {
            opacity: 0.5;
        }
        
        .seat.drag-over {
            background: rgba(152, 164, 201, 0.3) !important;
            border: 3px dashed #98A4C9 !important;
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-content h3 {
            margin-bottom: 15px;
            color: #98A4C9;
        }
        
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }
        
        .side-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .side-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }
        
        .side-option:hover {
            transform: scale(1.05);
        }
        
        .side-option.selected {
            border-width: 3px;
        }
        
        .side-option.left {
            border-color: #98A4C9;
            background: #f0f2f8;
        }
        
        .side-option.left.selected {
            background: #98A4C9;
            color: white;
        }
        
        .side-option.right {
            border-color: #98A4C9;
            background: #f0f2f8;
        }
        
        .side-option.right.selected {
            background: #98A4C9;
            color: white;
        }
        
        .gender-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .gender-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }
        
        .gender-option:hover {
            transform: scale(1.05);
        }
        
        .gender-option.selected {
            border-width: 3px;
        }
        
        .gender-option.girl {
            border-color: #ffc0cb;
            background: #fff5f7;
        }
        
        .gender-option.girl.selected {
            background: #ffc0cb;
            color: white;
        }
        
        .gender-option.boy {
            border-color: #87ceeb;
            background: #f0f8ff;
        }
        
        .gender-option.boy.selected {
            background: #87ceeb;
            color: white;
        }
        
        .gender-option.other {
            border-color: #90ee90;
            background: #f0fff0;
        }
        
        .gender-option.other.selected {
            background: #90ee90;
            color: white;
        }
        
        .gender-option.provider {
            border-color: #9e9e9e;
            background: #f5f5f5;
        }
        
        .gender-option.provider.selected {
            background: #9e9e9e;
            color: white;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .legend {
            background: #f8f9fa;
            padding: 15px;
            border-top: 2px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .legend-box {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #666;
        }
        
        .legend-box.girl {
            background: #ffc0cb;
        }
        
        .legend-box.boy {
            background: #87ceeb;
        }
        
        .legend-box.other {
            background: #90ee90;
        }
        
        .legend-box.diet {
            background: #ffeb3b;
        }
        
        .legend-box.allergy {
            background: #f44336;
        }
        
        .legend-box.provider {
            background: #9e9e9e;
        }
        
        .legend-box.child {
            background: repeating-linear-gradient(
                45deg,
                #ff9800,
                #ff9800 4px,
                white 4px,
                white 8px
            );
        }
        
        /* Styles pour l'impression / export PDF */
        @media print {
            body {
                background: white;
                padding: 0;
                margin: 0;
            }
            
            .header,
            .space-selector,
            .toolbar,
            .legend,
            .sidebar {
                display: none !important;
            }
            
            .container {
                max-width: none;
                box-shadow: none;
                border-radius: 0;
            }
            
            .main-content {
                height: auto;
                display: block;
            }
            
            .canvas-container {
                overflow: visible;
                background: white;
                page-break-after: always;
            }
            
            #canvas {
                position: relative;
                transform: scale(1);
                transform-origin: top left;
                page-break-inside: avoid;
            }
            
            .space-info-overlay {
                position: absolute;
                top: 20px;
                left: 20px;
                right: auto;
                background: white;
                border: 3px solid #98A4C9;
                padding: 20px;
                font-size: 16px;
            }
            
            .table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéä Plan de Table Mariage üéä</h1>
            <p>Glissez-d√©posez vos tables et assignez vos invit√©s</p>
            <div class="couple-names">
                <div class="couple-input-group">
                    <input type="text" id="leftSpouseName" placeholder="Pr√©nom Mari√©(e) 1">
                    <div class="gender-toggle">
                        <button id="leftGirl" onclick="setSpouseGender('left', 'girl')">üë∞</button>
                        <button id="leftBoy" onclick="setSpouseGender('left', 'boy')">ü§µ</button>
                        <button id="leftOther" onclick="setSpouseGender('left', 'other')">üåü</button>
                    </div>
                </div>
                <span id="coupleIcon">üíï</span>
                <div class="couple-input-group">
                    <input type="text" id="rightSpouseName" placeholder="Pr√©nom Mari√©(e) 2">
                    <div class="gender-toggle">
                        <button id="rightGirl" onclick="setSpouseGender('right', 'girl')">üë∞</button>
                        <button id="rightBoy" onclick="setSpouseGender('right', 'boy')">ü§µ</button>
                        <button id="rightOther" onclick="setSpouseGender('right', 'other')">üåü</button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <input type="date" id="weddingDate" style="padding: 8px 15px; border: 2px solid white; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.9); color: #333; text-align: center;">
            </div>
        </div>
        
        <!-- S√©lecteur d'espaces -->
        <div class="space-selector">
            <button class="space-btn active" onclick="switchSpace('guinguette')" id="space-btn-guinguette">
                <div class="space-name">üå∏ Guinguette en Terrasse</div>
                <div class="space-size">30m √ó 5m</div>
                <div class="space-stats" id="stats-guinguette">0 tables ‚Ä¢ 0 invit√©s</div>
            </button>
            <button class="space-btn" onclick="switchSpace('platanes')" id="space-btn-platanes">
                <div class="space-name">üå≥ All√©e des Platanes</div>
                <div class="space-size">27m √ó 6m</div>
                <div class="space-stats" id="stats-platanes">0 tables ‚Ä¢ 0 invit√©s</div>
            </button>
            <button class="space-btn" onclick="switchSpace('ciel')" id="space-btn-ciel">
                <div class="space-name">‚≠ê Ciel √âtoil√©</div>
                <div class="space-size">20m √ó 20m</div>
                <div class="space-stats" id="stats-ciel">0 tables ‚Ä¢ 0 invit√©s</div>
            </button>
        </div>
        
        <div class="toolbar">
            <div class="table-selector">
                <label>Ajouter une table :</label>
                <select id="tableType">
                    <option value="round8">Table ronde 8 places</option>
                    <option value="round10">Table ronde 10 places</option>
                    <option value="rect6">Table rectangulaire 6 places (honneur)</option>
                    <option value="rect8">Table rectangulaire 8 places</option>
                </select>
                <button class="btn btn-primary" onclick="addTable()">+ Ajouter</button>
            </div>
            <button class="btn btn-secondary" onclick="deleteSelected()">üóëÔ∏è Supprimer</button>
            <button class="btn btn-secondary" onclick="saveLayout()">üíæ Sauvegarder</button>
            <button class="btn btn-secondary" onclick="loadLayout()">üìÇ Charger</button>
            <button class="btn btn-secondary" onclick="exportGuestList()">üìã Export liste invit√©s</button>
            <button class="btn btn-secondary" onclick="exportPDF()">üìÑ Exporter PDF</button>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box girl"></div>
                <span>Fille</span>
            </div>
            <div class="legend-item">
                <div class="legend-box boy"></div>
                <span>Gar√ßon</span>
            </div>
            <div class="legend-item">
                <div class="legend-box child">üë∂</div>
                <span>Enfant</span>
            </div>
            <div class="legend-item">
                <div class="legend-box other"></div>
                <span>Autre</span>
            </div>
            <div class="legend-item">
                <div class="legend-box diet"></div>
                <span>R√©gime alimentaire</span>
            </div>
            <div class="legend-item">
                <div class="legend-box allergy"></div>
                <span>Allergie</span>
            </div>
            <div class="legend-item">
                <div class="legend-box provider"></div>
                <span>Prestataire</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="canvas-container">
                <div id="canvas"></div>
                <div class="space-info-overlay" id="spaceInfo"></div>
            </div>
            
            <div class="sidebar">
                <h3>üë• Gestion des invit√©s</h3>
                <div class="guest-input">
                    <input type="text" id="guestName" placeholder="Nom de l'invit√©">
                    <button class="btn btn-primary" onclick="addGuest()">Ajouter invit√©</button>
                </div>
                <p style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">
                    üí° Glissez-d√©posez les invit√©s de la liste vers les places des tables
                </p>
                
                <h3>Liste des invit√©s</h3>
                <div class="guest-list" id="guestList"></div>
                
                <div style="margin-top: 20px;">
                    <h3>Statistiques</h3>
                    <p id="stats"></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="seatModal">
        <div class="modal-content">
            <h3>Assigner un invit√©</h3>
            <input type="text" id="seatGuestInput" placeholder="Nom de l'invit√©">
            
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">C√¥t√© du mari√©/mari√©e :</label>
            <div class="side-selector">
                <div class="side-option left" id="sideLeft" onclick="selectSide('left')">
                    <div style="font-size: 20px; margin-bottom: 5px;">üë∞</div>
                    <div id="leftSideLabel">C√¥t√© Mari√©(e) 1</div>
                </div>
                <div class="side-option right" id="sideRight" onclick="selectSide('right')">
                    <div style="font-size: 20px; margin-bottom: 5px;">ü§µ</div>
                    <div id="rightSideLabel">C√¥t√© Mari√©(e) 2</div>
                </div>
            </div>
            
            <div class="gender-selector">
                <div class="gender-option girl" id="genderGirl" onclick="selectGender('girl')">
                    <div style="font-size: 20px; margin-bottom: 5px;">üëß</div>
                    <div>Fille</div>
                </div>
                <div class="gender-option boy" id="genderBoy" onclick="selectGender('boy')">
                    <div style="font-size: 20px; margin-bottom: 5px;">üë¶</div>
                    <div>Gar√ßon</div>
                </div>
                <div class="gender-option other" id="genderOther" onclick="selectGender('other')">
                    <div style="font-size: 20px; margin-bottom: 5px;">üåü</div>
                    <div>Autre</div>
                </div>
                <div class="gender-option provider" id="genderProvider" onclick="selectGender('provider')">
                    <div style="font-size: 20px; margin-bottom: 5px;">üëî</div>
                    <div>Prestataire</div>
                </div>
            </div>
            
            <div id="providerJobField" style="display: none; margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">M√©tier du prestataire :</label>
                <input type="text" id="providerJobInput" placeholder="Ex: DJ, Photographe, Traiteur...">
            </div>
            
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">R√©gime alimentaire :</label>
            <input type="text" id="dietInput" placeholder="Ex: V√©g√©tarien, Sans gluten, Halal..." style="margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Allergie :</label>
            <input type="text" id="allergyInput" placeholder="Ex: Arachides, Fruits de mer, Lactose..." style="margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 5px;">
                <input type="checkbox" id="isChildCheckbox" style="margin-right: 5px; width: auto;">
                <span style="font-weight: bold;">Cet invit√© est un enfant</span>
            </label>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeSeatModal()">Annuler</button>
                <button class="btn btn-primary" onclick="assignGuest()">Assigner</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="tableNameModal">
        <div class="modal-content">
            <h3>Nommer la table</h3>
            <input type="text" id="tableNameInput" placeholder="Ex: Famille, Amis, Coll√®gues...">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeTableNameModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveTableName()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        let tables = [];
        let guests = [];
        let guestData = {}; // Stocke les infos compl√®tes de chaque invit√©
        let selectedTable = null;
        let selectedSeat = null;
        let selectedTableForName = null;
        let selectedSide = null;
        let selectedGender = null;
        let tableCounter = 1;
        let draggedElement = null;
        let offsetX = 0;
        let offsetY = 0;
        let spouseGenders = { left: null, right: null };
        
        // Configuration des espaces
        const spaces = {
            guinguette: {
                name: "Guinguette en Terrasse",
                width: 1200,  // 30m √ó 40px/m
                height: 200,  // 5m √ó 40px/m
                realWidth: 30,
                realHeight: 5,
                color: "#fafafa",
                tables: []
            },
            platanes: {
                name: "All√©e des Platanes",
                width: 1080,  // 27m √ó 40px/m
                height: 240,  // 6m √ó 40px/m
                realWidth: 27,
                realHeight: 6,
                color: "#fafafa",
                tables: []
            },
            ciel: {
                name: "Ciel √âtoil√©",
                width: 800,   // 20m √ó 40px/m
                height: 800,  // 20m √ó 20m √ó 40px/m
                realWidth: 20,
                realHeight: 20,
                color: "#fafafa",
                tables: []
            }
        };
        
        let currentSpace = 'guinguette';
        
        // Initialisation du canvas
        function initCanvas() {
            const canvas = document.getElementById('canvas');
            const space = spaces[currentSpace];
            canvas.style.width = space.width + 'px';
            canvas.style.height = space.height + 'px';
            canvas.style.background = space.color;
            
            // Ajouter les √©l√©ments visuels d'entr√©e/escalier
            addSpaceElements(canvas, currentSpace);
            
            updateSpaceInfo();
        }
        
        function addSpaceElements(canvas, spaceName) {
            // Supprimer les anciens √©l√©ments
            const oldElements = canvas.querySelectorAll('.space-element');
            oldElements.forEach(el => el.remove());
            
            const space = spaces[spaceName];
            
            if (spaceName === 'guinguette') {
                // Escalier au milieu (bas de la terrasse)
                const staircase = document.createElement('div');
                staircase.className = 'space-element staircase';
                staircase.style.position = 'absolute';
                staircase.style.bottom = '0';
                staircase.style.left = `${(space.width - 80) / 2}px`; // Centr√©
                staircase.style.width = '80px'; // ~2m
                staircase.style.height = '30px';
                staircase.style.background = 'repeating-linear-gradient(0deg, #666 0px, #666 5px, #888 5px, #888 10px)';
                staircase.style.border = '2px solid #555';
                staircase.style.borderBottom = 'none';
                staircase.style.zIndex = '50';
                staircase.title = 'Escalier vers All√©e des Platanes';
                
                // Label
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.top = '5px';
                label.style.left = '50%';
                label.style.transform = 'translateX(-50%)';
                label.style.fontSize = '10px';
                label.style.color = 'white';
                label.style.fontWeight = 'bold';
                label.style.textShadow = '1px 1px 2px black';
                label.textContent = '‚Üì';
                staircase.appendChild(label);
                
                canvas.appendChild(staircase);
                
            } else if (spaceName === 'platanes') {
                // Escalier au milieu (haut de l'all√©e)
                const staircase = document.createElement('div');
                staircase.className = 'space-element staircase';
                staircase.style.position = 'absolute';
                staircase.style.top = '0';
                staircase.style.left = `${(space.width - 80) / 2}px`; // Centr√©
                staircase.style.width = '80px'; // ~2m
                staircase.style.height = '30px';
                staircase.style.background = 'repeating-linear-gradient(180deg, #666 0px, #666 5px, #888 5px, #888 10px)';
                staircase.style.border = '2px solid #555';
                staircase.style.borderTop = 'none';
                staircase.style.zIndex = '50';
                staircase.title = 'Escalier vers Terrasse';
                
                // Label
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.bottom = '5px';
                label.style.left = '50%';
                label.style.transform = 'translateX(-50%)';
                label.style.fontSize = '10px';
                label.style.color = 'white';
                label.style.fontWeight = 'bold';
                label.style.textShadow = '1px 1px 2px black';
                label.textContent = '‚Üë';
                staircase.appendChild(label);
                
                canvas.appendChild(staircase);
                
            } else if (spaceName === 'ciel') {
                // Entr√©e au milieu en haut
                const entrance = document.createElement('div');
                entrance.className = 'space-element entrance';
                entrance.style.position = 'absolute';
                entrance.style.top = '0';
                entrance.style.left = `${(space.width - 120) / 2}px`; // Centr√©
                entrance.style.width = '120px'; // ~3m
                entrance.style.height = '20px';
                entrance.style.background = 'linear-gradient(to bottom, transparent, rgba(152,164,201,0.3))';
                entrance.style.borderLeft = '3px solid #98A4C9';
                entrance.style.borderRight = '3px solid #98A4C9';
                entrance.style.borderBottom = '3px dashed #98A4C9';
                entrance.style.zIndex = '50';
                entrance.title = 'Entr√©e';
                
                // Label
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.top = '25px';
                label.style.left = '50%';
                label.style.transform = 'translateX(-50%)';
                label.style.fontSize = '12px';
                label.style.color = '#98A4C9';
                label.style.fontWeight = 'bold';
                label.style.background = 'white';
                label.style.padding = '2px 8px';
                label.style.borderRadius = '4px';
                label.style.border = '2px solid #98A4C9';
                label.textContent = 'üö™ ENTR√âE';
                entrance.appendChild(label);
                
                canvas.appendChild(entrance);
            }
        }
        
        function updateSpaceInfo() {
            const space = spaces[currentSpace];
            const info = document.getElementById('spaceInfo');
            const tableCount = space.tables.length;
            const guestCount = space.tables.reduce((sum, t) => 
                sum + t.guests.filter(g => g !== null).length, 0);
            
            const leftSpouse = document.getElementById('leftSpouseName').value.trim() || 'Mari√©(e) 1';
            const rightSpouse = document.getElementById('rightSpouseName').value.trim() || 'Mari√©(e) 2';
            const weddingDate = document.getElementById('weddingDate').value;
            const formattedDate = weddingDate ? new Date(weddingDate).toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            }) : 'Date non d√©finie';
            
            info.innerHTML = `
                <h3>${space.name}</h3>
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6;">
                    <strong>üíë ${leftSpouse} & ${rightSpouse}</strong><br>
                    <span style="font-size: 11px;">üìÖ ${formattedDate}</span>
                </div>
                <div>üìê ${space.realWidth}m √ó ${space.realHeight}m</div>
                <div>ü™ë ${tableCount} tables</div>
                <div><strong>üë• ${guestCount} invit√©s plac√©s</strong></div>
            `;
        }
        
        function switchSpace(spaceName) {
            // Sauvegarder les tables de l'espace actuel (copie profonde)
            spaces[currentSpace].tables = JSON.parse(JSON.stringify(tables));
            
            // Changer d'espace
            currentSpace = spaceName;
            
            // Charger les tables du nouvel espace (copie profonde)
            tables = JSON.parse(JSON.stringify(spaces[currentSpace].tables));
            
            // Mettre √† jour l'UI
            document.querySelectorAll('.space-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`space-btn-${spaceName}`).classList.add('active');
            
            initCanvas();
            renderTables();
            updateStats();
            updateAllSpaceStats();
        }
        
        function updateAllSpaceStats() {
            Object.keys(spaces).forEach(spaceKey => {
                const space = spaces[spaceKey];
                const tableCount = space.tables.length;
                const guestCount = space.tables.reduce((sum, t) => 
                    sum + t.guests.filter(g => g !== null).length, 0);
                
                document.getElementById(`stats-${spaceKey}`).textContent = 
                    `${tableCount} tables ‚Ä¢ ${guestCount} invit√©s`;
            });
        }
        
        // Mettre √† jour les labels des c√¥t√©s quand les noms changent
        document.getElementById('leftSpouseName').addEventListener('input', updateSideLabels);
        document.getElementById('rightSpouseName').addEventListener('input', updateSideLabels);
        
        // Mettre √† jour l'info de l'espace quand la date change
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('weddingDate');
            if (dateInput) {
                dateInput.addEventListener('change', updateSpaceInfo);
            }
        });
        
        function setSpouseGender(side, gender) {
            spouseGenders[side] = gender;
            
            // D√©finir les couleurs selon le genre
            const colors = {
                girl: '#ffc0cb',   // Rose
                boy: '#87ceeb',    // Bleu
                other: '#90ee90'   // Vert
            };
            
            // Mettre √† jour les boutons actifs et la couleur de l'input
            if (side === 'left') {
                const input = document.getElementById('leftSpouseName');
                document.getElementById('leftGirl').classList.remove('active');
                document.getElementById('leftBoy').classList.remove('active');
                document.getElementById('leftOther').classList.remove('active');
                
                if (gender === 'girl') {
                    document.getElementById('leftGirl').classList.add('active');
                    input.style.setProperty('background', colors.girl, 'important');
                } else if (gender === 'boy') {
                    document.getElementById('leftBoy').classList.add('active');
                    input.style.setProperty('background', colors.boy, 'important');
                } else if (gender === 'other') {
                    document.getElementById('leftOther').classList.add('active');
                    input.style.setProperty('background', colors.other, 'important');
                }
            } else {
                const input = document.getElementById('rightSpouseName');
                document.getElementById('rightGirl').classList.remove('active');
                document.getElementById('rightBoy').classList.remove('active');
                document.getElementById('rightOther').classList.remove('active');
                
                if (gender === 'girl') {
                    document.getElementById('rightGirl').classList.add('active');
                    input.style.setProperty('background', colors.girl, 'important');
                } else if (gender === 'boy') {
                    document.getElementById('rightBoy').classList.add('active');
                    input.style.setProperty('background', colors.boy, 'important');
                } else if (gender === 'other') {
                    document.getElementById('rightOther').classList.add('active');
                    input.style.setProperty('background', colors.other, 'important');
                }
            }
            
            updateSideLabels();
        }
        
        function updateSideLabels() {
            const leftName = document.getElementById('leftSpouseName').value.trim() || 'Mari√©(e) 1';
            const rightName = document.getElementById('rightSpouseName').value.trim() || 'Mari√©(e) 2';
            
            // Mettre √† jour les ic√¥nes dans le modal
            const leftIcon = spouseGenders.left === 'girl' ? 'üë∞' : (spouseGenders.left === 'boy' ? 'ü§µ' : (spouseGenders.left === 'other' ? 'üåü' : 'üë∞'));
            const rightIcon = spouseGenders.right === 'girl' ? 'üë∞' : (spouseGenders.right === 'boy' ? 'ü§µ' : (spouseGenders.right === 'other' ? 'üåü' : 'ü§µ'));
            
            document.getElementById('sideLeft').querySelector('div').textContent = leftIcon;
            document.getElementById('sideRight').querySelector('div').textContent = rightIcon;
            
            document.getElementById('leftSideLabel').textContent = `C√¥t√© ${leftName}`;
            document.getElementById('rightSideLabel').textContent = `C√¥t√© ${rightName}`;
        }

        function addTable() {
            const type = document.getElementById('tableType').value;
            let seats, width, height, shape;
            
            if (type === 'round8') {
                seats = 8;
                width = height = 150;
                shape = 'round';
            } else if (type === 'round10') {
                seats = 10;
                width = height = 180;
                shape = 'round';
            } else if (type === 'rect6') {
                seats = 6;
                width = 250;
                height = 100;
                shape = 'rect6';
            } else if (type === 'rect8') {
                seats = 8;
                width = 200;
                height = 100;
                shape = 'rect8';
            }
            
            const table = {
                id: Date.now(),
                number: tableCounter++,
                name: '',
                type,
                seats,
                width,
                height,
                shape,
                x: 100 + (tables.length * 50),
                y: 100 + (tables.length * 30),
                guests: Array(seats).fill(null),
                guestSides: Array(seats).fill(null),
                guestGenders: Array(seats).fill(null),
                guestDiets: Array(seats).fill(null),
                guestAllergies: Array(seats).fill(null),
                guestIsChild: Array(seats).fill(false),
                guestProviderJob: Array(seats).fill(null),
                space: currentSpace
            };
            
            tables.push(table);
            renderTables();
            updateStats();
            updateAllSpaceStats();
        }
        
        function renderTables() {
            const canvas = document.getElementById('canvas');
            
            // Supprimer uniquement les tables, pas les √©l√©ments d'espace
            const oldTables = canvas.querySelectorAll('.table');
            oldTables.forEach(el => el.remove());
            
            tables.forEach(table => {
                const tableEl = document.createElement('div');
                tableEl.className = `table table-${table.shape}`;
                tableEl.style.width = table.width + 'px';
                tableEl.style.height = table.height + 'px';
                tableEl.style.left = table.x + 'px';
                tableEl.style.top = table.y + 'px';
                tableEl.dataset.tableId = table.id;
                
                const label = document.createElement('div');
                label.className = 'table-label';
                
                const tableName = document.createElement('div');
                tableName.textContent = table.name || `Table ${table.number}`;
                tableName.style.fontWeight = 'bold';
                label.appendChild(tableName);
                
                const occupiedSeats = table.guests.filter(g => g !== null).length;
                const tableInfo = document.createElement('div');
                tableInfo.className = 'table-info';
                tableInfo.textContent = `${table.seats} places (${occupiedSeats} occup√©e${occupiedSeats > 1 ? 's' : ''})`;
                label.appendChild(tableInfo);
                
                // Afficher les r√©gimes sp√©ciaux avec comptage
                const diets = table.guestDiets.filter(d => d !== null && d !== '');
                if (diets.length > 0) {
                    // Compter chaque r√©gime
                    const dietCount = {};
                    diets.forEach(diet => {
                        dietCount[diet] = (dietCount[diet] || 0) + 1;
                    });
                    
                    const dietInfo = document.createElement('div');
                    dietInfo.className = 'diet-info';
                    const dietTexts = Object.entries(dietCount).map(([diet, count]) => `${count} x ${diet}`);
                    dietInfo.textContent = dietTexts.join(', ');
                    label.appendChild(dietInfo);
                }
                
                // Afficher les allergies avec comptage
                const allergies = table.guestAllergies.filter(a => a !== null && a !== '');
                if (allergies.length > 0) {
                    // Compter chaque allergie
                    const allergyCount = {};
                    allergies.forEach(allergy => {
                        allergyCount[allergy] = (allergyCount[allergy] || 0) + 1;
                    });
                    
                    const allergyInfo = document.createElement('div');
                    allergyInfo.className = 'allergy-info';
                    const allergyTexts = Object.entries(allergyCount).map(([allergy, count]) => `${count} x ${allergy}`);
                    allergyInfo.textContent = '‚ö†Ô∏è ' + allergyTexts.join(', ');
                    label.appendChild(allergyInfo);
                }
                
                label.onclick = (e) => {
                    e.stopPropagation();
                    openTableNameModal(table);
                };
                tableEl.appendChild(label);
                
                // Ajouter les places
                for (let i = 0; i < table.seats; i++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    if (table.guests[i]) {
                        seat.className += ' assigned';
                        
                        // Ajouter les classes appropri√©es
                        const hasDiet = table.guestDiets[i];
                        const hasAllergy = table.guestAllergies[i];
                        const isChild = table.guestIsChild[i];
                        const isProvider = table.guestGenders[i] === 'provider';
                        
                        console.log('Guest:', table.guests[i], 'hasAllergy:', hasAllergy, 'hasDiet:', hasDiet, 'gender:', table.guestGenders[i]);
                        
                        // Toujours ajouter child si c'est un enfant
                        if (isChild && !isProvider) {
                            seat.className += ' child';
                        }
                        
                        if (isProvider) {
                            seat.className += ' provider';
                        } else if (hasAllergy && hasDiet) {
                            // Si les deux sont pr√©sents, couleur verte
                            seat.className += ' has-both';
                        } else if (hasAllergy) {
                            seat.className += ' has-allergy';
                            // Forcer le style directement
                            seat.style.backgroundColor = '#f44336';
                            seat.style.borderColor = '#d32f2f';
                            seat.style.color = 'white';
                            console.log('Applied has-allergy class and inline styles');
                        } else if (hasDiet) {
                            seat.className += ' has-diet';
                        } else {
                            if (table.guestGenders[i] === 'girl') {
                                seat.className += ' gender-girl';
                            } else if (table.guestGenders[i] === 'boy') {
                                seat.className += ' gender-boy';
                            } else if (table.guestGenders[i] === 'other') {
                                seat.className += ' gender-other';
                            }
                        }
                        
                        console.log('Final classes:', seat.className);
                        
                        // Afficher la premi√®re lettre du c√¥t√© entre parenth√®ses
                        const leftSpouse = document.getElementById('leftSpouseName').value.trim();
                        const rightSpouse = document.getElementById('rightSpouseName').value.trim();
                        let sideInitial = '';
                        
                        if (!isProvider) {
                            if (table.guestSides[i] === 'left' && leftSpouse) {
                                sideInitial = `(${leftSpouse[0].toUpperCase()}) `;
                            } else if (table.guestSides[i] === 'right' && rightSpouse) {
                                sideInitial = `(${rightSpouse[0].toUpperCase()}) `;
                            }
                        }
                        
                        // Cr√©er la structure avec nom et r√©gime/m√©tier s√©par√©s
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'seat-name';
                        let displayName = '';
                        if (isChild) {
                            displayName = 'üë∂ ' + sideInitial + table.guests[i];
                        } else {
                            displayName = sideInitial + table.guests[i];
                        }
                        nameDiv.textContent = displayName;
                        nameDiv.style.display = 'block';
                        nameDiv.style.width = '100%';
                        seat.appendChild(nameDiv);
                        
                        if (isProvider && table.guestProviderJob[i]) {
                            const jobDiv = document.createElement('div');
                            jobDiv.className = 'seat-diet';
                            jobDiv.textContent = '- ' + table.guestProviderJob[i];
                            jobDiv.style.display = 'block';
                            jobDiv.style.width = '100%';
                            seat.appendChild(jobDiv);
                        } else if (table.guestAllergies[i]) {
                            const allergyDiv = document.createElement('div');
                            allergyDiv.className = 'seat-diet';
                            allergyDiv.textContent = '- ' + table.guestAllergies[i];
                            allergyDiv.style.display = 'block';
                            allergyDiv.style.width = '100%';
                            seat.appendChild(allergyDiv);
                        } else if (table.guestDiets[i]) {
                            const dietDiv = document.createElement('div');
                            dietDiv.className = 'seat-diet';
                            dietDiv.textContent = '- ' + table.guestDiets[i];
                            dietDiv.style.display = 'block';
                            dietDiv.style.width = '100%';
                            seat.appendChild(dietDiv);
                        }
                        
                        let tooltipText = table.guests[i];
                        if (isProvider && table.guestProviderJob[i]) {
                            tooltipText += `\nM√©tier: ${table.guestProviderJob[i]}`;
                        }
                        if (table.guestAllergies[i]) {
                            tooltipText += `\nAllergie: ${table.guestAllergies[i]}`;
                        }
                        if (table.guestDiets[i]) {
                            tooltipText += `\nR√©gime: ${table.guestDiets[i]}`;
                        }
                        if (isChild) {
                            tooltipText += `\nEnfant`;
                        }
                        seat.title = tooltipText;
                    } else {
                        seat.textContent = `Place ${i + 1}`;
                    }
                    
                    // Position des si√®ges autour de la table
                    const angle = (i / table.seats) * Math.PI * 2 - Math.PI / 2;
                    const radius = table.shape === 'round' ? table.width / 2 + 60 : 
                                   (i < table.seats / 2 ? table.width / 2 + 60 : table.width / 2 + 60);
                    
                    if (table.shape === 'rect6') {
                        // Table rectangulaire 6 places : 3 en haut, 3 en bas, pas de c√¥t√©s
                        if (i < 3) {
                            seat.style.left = ((i) * (table.width / 3) + (table.width / 6) - 40) + 'px';
                            seat.style.top = '-50px';
                        } else {
                            seat.style.left = ((i - 3) * (table.width / 3) + (table.width / 6) - 40) + 'px';
                            seat.style.top = (table.height + 20) + 'px';
                        }
                    } else if (table.shape === 'rect8') {
                        // Table rectangulaire 8 places : 3 en haut, 3 en bas, 1 de chaque c√¥t√©
                        if (i < 3) {
                            // Haut
                            seat.style.left = ((i) * (table.width / 3) + (table.width / 6) - 40) + 'px';
                            seat.style.top = '-50px';
                        } else if (i === 3) {
                            // Gauche
                            seat.style.left = '-60px';
                            seat.style.top = (table.height / 2 - 20) + 'px';
                        } else if (i === 4) {
                            // Droite
                            seat.style.left = (table.width + 20) + 'px';
                            seat.style.top = (table.height / 2 - 20) + 'px';
                        } else {
                            // Bas
                            seat.style.left = ((i - 5) * (table.width / 3) + (table.width / 6) - 40) + 'px';
                            seat.style.top = (table.height + 20) + 'px';
                        }
                    } else if (table.shape === 'round') {
                        seat.style.left = (table.width / 2 + Math.cos(angle) * radius - 40) + 'px';
                        seat.style.top = (table.height / 2 + Math.sin(angle) * radius - 20) + 'px';
                    }
                    
                    seat.onclick = (e) => {
                        e.stopPropagation();
                        openSeatModal(table.id, i);
                    };
                    
                    // Ajouter les √©v√©nements de drop
                    seat.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        if (!table.guests[i]) {
                            seat.classList.add('drag-over');
                        }
                    });
                    
                    seat.addEventListener('dragleave', (e) => {
                        seat.classList.remove('drag-over');
                    });
                    
                    seat.addEventListener('drop', (e) => {
                        e.preventDefault();
                        seat.classList.remove('drag-over');
                        
                        if (!table.guests[i]) {
                            const guestName = e.dataTransfer.getData('text/plain');
                            if (guestName) {
                                // Ouvrir le modal avec les donn√©es pr√©-remplies
                                selectedSeat = { tableId: table.id, seatIndex: i };
                                document.getElementById('seatGuestInput').value = guestName;
                                
                                // Pr√©-remplir avec les donn√©es stock√©es si elles existent
                                const data = guestData[guestName] || {};
                                document.getElementById('dietInput').value = data.diet || '';
                                document.getElementById('allergyInput').value = data.allergy || '';
                                document.getElementById('providerJobInput').value = data.providerJob || '';
                                document.getElementById('isChildCheckbox').checked = data.isChild || false;
                                
                                selectedSide = data.side || null;
                                selectedGender = data.gender || null;
                                
                                updateSideSelection();
                                updateGenderSelection();
                                
                                // Afficher/masquer le champ m√©tier si provider
                                if (data.gender === 'provider') {
                                    document.getElementById('providerJobField').style.display = 'block';
                                }
                                
                                document.getElementById('seatModal').classList.add('active');
                            }
                        }
                    });
                    
                    tableEl.appendChild(seat);
                }
                
                tableEl.onmousedown = (e) => startDrag(e, table);
                tableEl.onclick = () => selectTable(table);
                
                canvas.appendChild(tableEl);
            });
        }
        
        function startDrag(e, table) {
            if (e.target.classList.contains('seat')) return;
            
            draggedElement = table;
            const tableEl = document.querySelector(`[data-table-id="${table.id}"]`);
            const rect = tableEl.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            document.onmousemove = drag;
            document.onmouseup = stopDrag;
            e.preventDefault();
        }
        
        function drag(e) {
            if (!draggedElement) return;
            
            const canvas = document.getElementById('canvas');
            const canvasRect = canvas.getBoundingClientRect();
            
            draggedElement.x = e.clientX - canvasRect.left - offsetX + canvas.scrollLeft;
            draggedElement.y = e.clientY - canvasRect.top - offsetY + canvas.scrollTop;
            
            renderTables();
        }
        
        function stopDrag() {
            draggedElement = null;
            document.onmousemove = null;
            document.onmouseup = null;
        }
        
        function selectTable(table) {
            selectedTable = table;
            renderTables();
            document.querySelectorAll('.table').forEach(el => {
                if (parseInt(el.dataset.tableId) === table.id) {
                    el.classList.add('selected');
                }
            });
        }
        
        function deleteSelected() {
            if (selectedTable) {
                tables = tables.filter(t => t.id !== selectedTable.id);
                selectedTable = null;
                renderTables();
                updateStats();
            }
        }
        
        function openSeatModal(tableId, seatIndex) {
            selectedSeat = { tableId, seatIndex };
            const table = tables.find(t => t.id === tableId);
            document.getElementById('seatGuestInput').value = table.guests[seatIndex] || '';
            document.getElementById('dietInput').value = table.guestDiets[seatIndex] || '';
            document.getElementById('allergyInput').value = table.guestAllergies[seatIndex] || '';
            document.getElementById('providerJobInput').value = table.guestProviderJob[seatIndex] || '';
            document.getElementById('isChildCheckbox').checked = table.guestIsChild[seatIndex] || false;
            selectedSide = table.guestSides[seatIndex] || null;
            selectedGender = table.guestGenders[seatIndex] || null;
            updateSideSelection();
            updateGenderSelection();
            document.getElementById('seatModal').classList.add('active');
        }
        
        function selectSide(side) {
            selectedSide = side;
            updateSideSelection();
        }
        
        function selectGender(gender) {
            selectedGender = gender;
            updateGenderSelection();
            
            // Afficher/cacher le champ m√©tier si prestataire
            if (gender === 'provider') {
                document.getElementById('providerJobField').style.display = 'block';
            } else {
                document.getElementById('providerJobField').style.display = 'none';
            }
        }
        
        function updateSideSelection() {
            document.getElementById('sideLeft').classList.remove('selected');
            document.getElementById('sideRight').classList.remove('selected');
            if (selectedSide === 'left') {
                document.getElementById('sideLeft').classList.add('selected');
            } else if (selectedSide === 'right') {
                document.getElementById('sideRight').classList.add('selected');
            }
        }
        
        function updateGenderSelection() {
            document.getElementById('genderGirl').classList.remove('selected');
            document.getElementById('genderBoy').classList.remove('selected');
            document.getElementById('genderOther').classList.remove('selected');
            document.getElementById('genderProvider').classList.remove('selected');
            if (selectedGender === 'girl') {
                document.getElementById('genderGirl').classList.add('selected');
            } else if (selectedGender === 'boy') {
                document.getElementById('genderBoy').classList.add('selected');
            } else if (selectedGender === 'other') {
                document.getElementById('genderOther').classList.add('selected');
            } else if (selectedGender === 'provider') {
                document.getElementById('genderProvider').classList.add('selected');
            }
        }
        
        function closeSeatModal() {
            document.getElementById('seatModal').classList.remove('active');
            selectedSeat = null;
            selectedSide = null;
            selectedGender = null;
        }
        
        function assignGuest() {
            const guestName = document.getElementById('seatGuestInput').value.trim();
            const diet = document.getElementById('dietInput').value.trim();
            const allergy = document.getElementById('allergyInput').value.trim();
            const providerJob = document.getElementById('providerJobInput').value.trim();
            const isChild = document.getElementById('isChildCheckbox').checked;
            
            if (!guestName || !selectedSeat || !selectedGender) {
                if (!selectedGender) {
                    alert('Veuillez s√©lectionner une option (Fille, Gar√ßon, Autre ou Prestataire)');
                }
                return;
            }
            
            // Si ce n'est pas un prestataire, v√©rifier le c√¥t√©
            if (selectedGender !== 'provider' && !selectedSide) {
                alert('Veuillez s√©lectionner le c√¥t√© du mari√© ou de la mari√©e');
                return;
            }
            
            const table = tables.find(t => t.id === selectedSeat.tableId);
            table.guests[selectedSeat.seatIndex] = guestName;
            table.guestSides[selectedSeat.seatIndex] = selectedGender === 'provider' ? null : selectedSide;
            table.guestGenders[selectedSeat.seatIndex] = selectedGender;
            table.guestDiets[selectedSeat.seatIndex] = diet || null;
            table.guestAllergies[selectedSeat.seatIndex] = allergy || null;
            table.guestIsChild[selectedSeat.seatIndex] = selectedGender === 'provider' ? false : isChild;
            table.guestProviderJob[selectedSeat.seatIndex] = selectedGender === 'provider' ? providerJob : null;
            
            if (!guests.includes(guestName)) {
                guests.push(guestName);
            }
            
            // Mettre √† jour guestData avec les informations compl√®tes
            guestData[guestName] = {
                side: selectedGender === 'provider' ? null : selectedSide,
                gender: selectedGender,
                isChild: selectedGender === 'provider' ? false : isChild,
                diet: diet || null,
                allergy: allergy || null,
                providerJob: selectedGender === 'provider' ? providerJob : null
            };
            
            closeSeatModal();
            renderTables();
            renderGuestList();
            updateStats();
        }
        
        function addGuest() {
            const name = document.getElementById('guestName').value.trim();
            if (name && !guests.includes(name)) {
                guests.push(name);
                document.getElementById('guestName').value = '';
                renderGuestList();
                updateStats();
            }
        }
        
        function renderGuestList() {
            const list = document.getElementById('guestList');
            list.innerHTML = '';
            
            // Toutes les tables de tous les espaces
            const allTables = Object.values(spaces).flatMap(s => s.tables);
            
            guests.forEach(guest => {
                const item = document.createElement('div');
                item.className = 'guest-item';
                item.draggable = true;
                
                const isAssigned = allTables.some(t => t.guests.includes(guest));
                if (isAssigned) {
                    item.classList.add('assigned');
                    const tableInfo = allTables.find(t => t.guests.includes(guest));
                    const seatIndex = tableInfo.guests.indexOf(guest);
                    
                    // Utiliser le nom personnalis√© de la table si disponible, sinon le num√©ro
                    const tableName = tableInfo.name || `Table ${tableInfo.number}`;
                    item.textContent = `${guest} (${tableName})`;
                    item.draggable = false;
                    
                    // Stocker les infos dans des data attributes
                    item.dataset.tableId = tableInfo.id;
                    item.dataset.seatIndex = seatIndex;
                    item.dataset.clickable = 'true';
                    
                } else {
                    item.textContent = guest;
                    item.dataset.guestName = guest;
                    
                    // √âv√©nements de drag
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', guest);
                        item.classList.add('dragging');
                    });
                    
                    item.addEventListener('dragend', (e) => {
                        item.classList.remove('dragging');
                    });
                }
                
                list.appendChild(item);
            });
        }
        
        // Ajouter l'√©couteur d'√©v√©nement au conteneur
        document.addEventListener('DOMContentLoaded', () => {
            const guestList = document.getElementById('guestList');
            if (guestList) {
                guestList.addEventListener('click', (e) => {
                    const target = e.target.closest('.guest-item');
                    if (target && target.dataset.clickable === 'true') {
                        const tableId = parseInt(target.dataset.tableId);
                        const seatIndex = parseInt(target.dataset.seatIndex);
                        console.log('Opening modal for table:', tableId, 'seat:', seatIndex);
                        openSeatModal(tableId, seatIndex);
                    }
                });
            }
        });
        
        function updateStats() {
            // Toutes les tables de tous les espaces
            const allTables = Object.values(spaces).flatMap(s => s.tables);
            
            const totalSeats = allTables.reduce((sum, t) => sum + t.seats, 0);
            const assignedSeats = allTables.reduce((sum, t) => 
                sum + t.guests.filter(g => g !== null).length, 0);
            
            // Compter les invit√©s par c√¥t√© et par type
            let leftCount = 0;
            let rightCount = 0;
            let childCount = 0;
            let providerCount = 0;
            let adultCount = 0;
            
            allTables.forEach(table => {
                table.guests.forEach((guest, i) => {
                    if (guest) {
                        if (table.guestGenders[i] === 'provider') {
                            providerCount++;
                        } else {
                            if (table.guestIsChild[i]) {
                                childCount++;
                            } else {
                                adultCount++;
                            }
                            if (table.guestSides[i] === 'left') leftCount++;
                            if (table.guestSides[i] === 'right') rightCount++;
                        }
                    }
                });
            });
            
            const leftSpouse = document.getElementById('leftSpouseName').value.trim() || 'Mari√©(e) 1';
            const rightSpouse = document.getElementById('rightSpouseName').value.trim() || 'Mari√©(e) 2';
            
            // Stats par espace
            let spaceStats = '<br><br><strong>Par espace:</strong><br>';
            Object.entries(spaces).forEach(([key, space]) => {
                const tableCount = space.tables.length;
                const guestCount = space.tables.reduce((sum, t) => 
                    sum + t.guests.filter(g => g !== null).length, 0);
                spaceStats += `${space.name}: ${tableCount} tables, ${guestCount} invit√©s<br>`;
            });
            
            document.getElementById('stats').innerHTML = `
                üìä Total invit√©s adultes: ${adultCount}<br>
                üë∂ Total invit√©s enfants: ${childCount}<br>
                üëî Total prestataires: ${providerCount}<br>
                <br>
                ü™ë Places totales: ${totalSeats}<br>
                ‚úÖ Places assign√©es: ${assignedSeats}<br>
                ‚ö™ Places libres: ${totalSeats - assignedSeats}<br>
                <br>
                üë• Invit√©s de ${leftSpouse}: ${leftCount}<br>
                üë• Invit√©s de ${rightSpouse}: ${rightCount}
                ${spaceStats}
            `;
            
            updateSpaceInfo();
            updateAllSpaceStats();
        }
        
        function saveLayout() {
            const leftSpouse = document.getElementById('leftSpouseName').value.trim();
            const rightSpouse = document.getElementById('rightSpouseName').value.trim();
            const weddingDate = document.getElementById('weddingDate').value;
            
            // Sauvegarder les tables de l'espace actuel
            spaces[currentSpace].tables = tables;
            
            const data = { 
                version: '2.0',
                tables, 
                guests, 
                leftSpouse, 
                rightSpouse, 
                weddingDate,
                spouseGenders,
                spaces: spaces,
                currentSpace,
                tableCounter
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plan-de-table-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Configuration sauvegard√©e !');
        }
        
        function loadLayout() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (data.leftSpouse) document.getElementById('leftSpouseName').value = data.leftSpouse;
                        if (data.rightSpouse) document.getElementById('rightSpouseName').value = data.rightSpouse;
                        if (data.weddingDate) document.getElementById('weddingDate').value = data.weddingDate;
                        
                        if (data.spouseGenders) {
                            spouseGenders = data.spouseGenders;
                            if (spouseGenders.left) setSpouseGender('left', spouseGenders.left);
                            if (spouseGenders.right) setSpouseGender('right', spouseGenders.right);
                        }
                        
                        guests = data.guests || [];
                        tableCounter = data.tableCounter || 1;
                        
                        if (data.spaces) {
                            Object.keys(spaces).forEach(key => {
                                if (data.spaces[key]) {
                                    spaces[key].tables = data.spaces[key].tables || [];
                                }
                            });
                        } else {
                            // Ancien format sans espaces
                            spaces.guinguette.tables = data.tables || [];
                        }
                        
                        currentSpace = data.currentSpace || 'guinguette';
                        tables = spaces[currentSpace].tables;
                        
                        switchSpace(currentSpace);
                        renderGuestList();
                        updateStats();
                        
                        alert('‚úÖ Configuration charg√©e !');
                    } catch (err) {
                        alert('‚ùå Erreur lors du chargement du fichier');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function exportPDF() {
            // Sauvegarder l'espace actuel
            spaces[currentSpace].tables = tables;
            
            const space = spaces[currentSpace];
            
            const instructions = `
üìÑ EXPORT PDF - ${space.name}

Vous allez exporter uniquement l'espace actuel.

Dans la fen√™tre d'impression :
1. Destination : "Enregistrer au format PDF"
2. Orientation : Paysage (recommand√©)
3. Marges : Minimales ou Aucune
4. Cochez "Graphiques d'arri√®re-plan" si disponible

Continuer ?
            `;
            
            if (!confirm(instructions)) return;
            
            // Cr√©er un conteneur temporaire pour l'impression
            const printContainer = document.createElement('div');
            printContainer.id = 'print-container';
            printContainer.style.display = 'none';
            
            const pageDiv = document.createElement('div');
            pageDiv.className = 'print-page';
            pageDiv.style.pageBreakAfter = 'always';
            pageDiv.style.position = 'relative';
            pageDiv.style.width = space.width + 'px';
            pageDiv.style.height = space.height + 'px';
            pageDiv.style.background = space.color;
            pageDiv.style.border = '4px solid #98A4C9';
            pageDiv.style.boxShadow = 'inset 0 0 0 2px rgba(152,164,201,0.3)';
            pageDiv.style.backgroundImage = 'linear-gradient(rgba(200,200,200,.2) 1px, transparent 1px), linear-gradient(90deg, rgba(200,200,200,.2) 1px, transparent 1px)';
            pageDiv.style.backgroundSize = '50px 50px';
            
            // Ajouter l'info de l'espace
            const leftSpouse = document.getElementById('leftSpouseName').value.trim() || 'Mari√©(e) 1';
            const rightSpouse = document.getElementById('rightSpouseName').value.trim() || 'Mari√©(e) 2';
            const weddingDate = document.getElementById('weddingDate').value;
            const formattedDate = weddingDate ? new Date(weddingDate).toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            }) : 'Date non d√©finie';
            const guestCount = space.tables.reduce((sum, t) => 
                sum + t.guests.filter(g => g !== null).length, 0);
            
            const infoDiv = document.createElement('div');
            infoDiv.style.position = 'absolute';
            infoDiv.style.top = '10px';
            infoDiv.style.left = '10px';
            infoDiv.style.background = 'rgba(255, 255, 255, 0.98)';
            infoDiv.style.border = '3px solid #98A4C9';
            infoDiv.style.padding = '15px';
            infoDiv.style.borderRadius = '10px';
            infoDiv.style.fontSize = '14px';
            infoDiv.style.zIndex = '10000';
            infoDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            infoDiv.innerHTML = `
                <h3 style="color: #98A4C9; margin-bottom: 10px;">${space.name}</h3>
                <div style="margin-bottom: 8px;"><strong>üíë ${leftSpouse} & ${rightSpouse}</strong></div>
                <div style="font-size: 12px; margin-bottom: 8px;">üìÖ ${formattedDate}</div>
                <div style="border-top: 1px solid #dee2e6; padding-top: 8px; margin-top: 8px;">
                    <div>üìê ${space.realWidth}m √ó ${space.realHeight}m</div>
                    <div>ü™ë ${space.tables.length} tables</div>
                    <div><strong>üë• ${guestCount} invit√©s</strong></div>
                </div>
            `;
            pageDiv.appendChild(infoDiv);
            
            // Ajouter les √©l√©ments d'espace (escaliers, entr√©es)
            if (currentSpace === 'guinguette') {
                const staircase = document.createElement('div');
                staircase.style.position = 'absolute';
                staircase.style.bottom = '0';
                staircase.style.left = `${(space.width - 80) / 2}px`;
                staircase.style.width = '80px';
                staircase.style.height = '30px';
                staircase.style.background = 'repeating-linear-gradient(0deg, #666 0px, #666 5px, #888 5px, #888 10px)';
                staircase.style.border = '2px solid #555';
                staircase.style.borderBottom = 'none';
                staircase.innerHTML = '<div style="position: absolute; top: 5px; left: 50%; transform: translateX(-50%); font-size: 10px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black;">‚Üì</div>';
                pageDiv.appendChild(staircase);
            } else if (currentSpace === 'platanes') {
                const staircase = document.createElement('div');
                staircase.style.position = 'absolute';
                staircase.style.top = '0';
                staircase.style.left = `${(space.width - 80) / 2}px`;
                staircase.style.width = '80px';
                staircase.style.height = '30px';
                staircase.style.background = 'repeating-linear-gradient(180deg, #666 0px, #666 5px, #888 5px, #888 10px)';
                staircase.style.border = '2px solid #555';
                staircase.style.borderTop = 'none';
                staircase.innerHTML = '<div style="position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); font-size: 10px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black;">‚Üë</div>';
                pageDiv.appendChild(staircase);
            } else if (currentSpace === 'ciel') {
                const entrance = document.createElement('div');
                entrance.style.position = 'absolute';
                entrance.style.top = '0';
                entrance.style.left = `${(space.width - 120) / 2}px`;
                entrance.style.width = '120px';
                entrance.style.height = '20px';
                entrance.style.background = 'linear-gradient(to bottom, transparent, rgba(152,164,201,0.3))';
                entrance.style.borderLeft = '3px solid #98A4C9';
                entrance.style.borderRight = '3px solid #98A4C9';
                entrance.style.borderBottom = '3px dashed #98A4C9';
                entrance.innerHTML = '<div style="position: absolute; top: 25px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #98A4C9; font-weight: bold; background: white; padding: 2px 8px; border-radius: 4px; border: 2px solid #98A4C9;">üö™ ENTR√âE</div>';
                pageDiv.appendChild(entrance);
            }
            
            // Ajouter les tables
            space.tables.forEach(table => {
                const tableEl = document.createElement('div');
                tableEl.style.position = 'absolute';
                tableEl.style.left = table.x + 'px';
                tableEl.style.top = table.y + 'px';
                tableEl.style.width = (table.shape === 'round' ? table.width : table.width) + 'px';
                tableEl.style.height = (table.shape === 'round' ? table.height : table.height) + 'px';
                tableEl.style.background = 'white';
                tableEl.style.border = '3px solid #98A4C9';
                tableEl.style.borderRadius = table.shape.includes('round') ? '50%' : '10px';
                tableEl.style.display = 'flex';
                tableEl.style.flexDirection = 'column';
                tableEl.style.alignItems = 'center';
                tableEl.style.justifyContent = 'center';
                tableEl.style.fontWeight = 'bold';
                tableEl.style.color = '#98A4C9';
                tableEl.style.fontSize = '14px';
                tableEl.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
                
                const tableName = table.name || `Table ${table.number}`;
                const occupiedSeats = table.guests.filter(g => g !== null).length;
                
                tableEl.innerHTML = `
                    <div style="font-size: 18px; margin-bottom: 3px;">${table.number}</div>
                    <div style="font-size: 10px; opacity: 0.7;">${occupiedSeats}/${table.seats}</div>
                    ${table.name ? `<div style="font-size: 9px; margin-top: 2px; font-style: italic;">${table.name}</div>` : ''}
                `;
                
                // Ajouter les si√®ges simplifi√©s
                for (let i = 0; i < table.seats; i++) {
                    if (table.guests[i]) {
                        const seat = document.createElement('div');
                        seat.style.position = 'absolute';
                        seat.style.minWidth = '60px';
                        seat.style.padding = '4px 8px';
                        seat.style.fontSize = '9px';
                        seat.style.background = '#fff';
                        seat.style.border = '2px solid #98A4C9';
                        seat.style.borderRadius = '8px';
                        seat.style.whiteSpace = 'nowrap';
                        seat.style.textAlign = 'center';
                        seat.style.color = '#333';
                        
                        // Couleurs selon allergie/r√©gime
                        const hasDiet = table.guestDiets[i];
                        const hasAllergy = table.guestAllergies[i];
                        const isProvider = table.guestGenders[i] === 'provider';
                        
                        if (isProvider) {
                            seat.style.background = '#9e9e9e';
                            seat.style.color = 'white';
                            seat.style.borderColor = '#757575';
                        } else if (hasAllergy && hasDiet) {
                            seat.style.background = '#f44336';
                            seat.style.borderColor = '#d32f2f';
                            seat.style.color = '#00ff00';
                        } else if (hasAllergy) {
                            seat.style.background = '#f44336';
                            seat.style.borderColor = '#d32f2f';
                            seat.style.color = 'white';
                        } else if (hasDiet) {
                            seat.style.background = '#ffeb3b';
                            seat.style.borderColor = '#fbc02d';
                            seat.style.color = '#000';
                        } else {
                            if (table.guestGenders[i] === 'girl') {
                                seat.style.background = '#ffc0cb';
                                seat.style.borderColor = '#ff91a4';
                                seat.style.color = '#333';
                            } else if (table.guestGenders[i] === 'boy') {
                                seat.style.background = '#87ceeb';
                                seat.style.borderColor = '#5dade2';
                                seat.style.color = '#333';
                            } else if (table.guestGenders[i] === 'other') {
                                seat.style.background = '#90ee90';
                                seat.style.borderColor = '#5cb85c';
                                seat.style.color = '#333';
                            }
                        }
                        
                        // Position des si√®ges
                        if (table.shape.includes('round')) {
                            const angle = (i / table.seats) * Math.PI * 2 - Math.PI / 2;
                            const radius = (table.width / 2) + 35;
                            seat.style.left = `calc(50% + ${Math.cos(angle) * radius}px - 30px)`;
                            seat.style.top = `calc(50% + ${Math.sin(angle) * radius}px - 12px)`;
                        } else {
                            const perSide = Math.ceil(table.seats / 2);
                            if (i < perSide) {
                                seat.style.left = `${(i * table.width / perSide) + 10}px`;
                                seat.style.top = '-30px';
                            } else {
                                const idx = i - perSide;
                                seat.style.left = `${(idx * table.width / (table.seats - perSide)) + 10}px`;
                                seat.style.bottom = '-30px';
                            }
                        }
                        
                        seat.textContent = table.guests[i];
                        tableEl.appendChild(seat);
                    }
                }
                
                pageDiv.appendChild(tableEl);
            });
            
            printContainer.appendChild(pageDiv);
            
            // Ajouter au body
            document.body.appendChild(printContainer);
            
            // Afficher le conteneur pour l'impression
            printContainer.style.display = 'block';
            
            // Lancer l'impression
            setTimeout(() => {
                window.print();
                
                // Nettoyer apr√®s l'impression
                setTimeout(() => {
                    document.body.removeChild(printContainer);
                }, 1000);
            }, 500);
        }
        
        function downloadExcelTemplate() {
            // Cette fonction n'est plus utilis√©e mais on la garde au cas o√π
        }
        
        function openGoogleSheetInfo() {
            const message = `üìä UTILISER GOOGLE SHEETS (RECOMMAND√â)\n\n` +
                `üîó Lien du mod√®le :\n` +
                `https://docs.google.com/spreadsheets/d/1dPjKQxVxVxVxVxVxVxVxVxVxVxVxVxVx/edit\n\n` +
                `üìã INSTRUCTIONS :\n\n` +
                `1Ô∏è‚É£ Cliquez sur "Fichier" > "Cr√©er une copie"\n` +
                `2Ô∏è‚É£ Remplissez vos invit√©s dans votre copie\n` +
                `   ‚Ä¢ Colonne A : Nom\n` +
                `   ‚Ä¢ Colonne B : Pr√©nom\n` +
                `   ‚Ä¢ Colonne C : C√¥t√© (pr√©nom mari√©)\n` +
                `   ‚Ä¢ Colonne D : girl/boy/other/provider\n` +
                `   ‚Ä¢ Colonne E : oui si enfant\n` +
                `   ‚Ä¢ Colonne F : R√©gime\n` +
                `   ‚Ä¢ Colonne G : Allergie\n` +
                `   ‚Ä¢ Colonne H : M√©tier (si prestataire)\n\n` +
                `3Ô∏è‚É£ T√©l√©chargez en CSV :\n` +
                `   Fichier > T√©l√©charger > CSV\n\n` +
                `4Ô∏è‚É£ Cliquez sur "üì§ Importer CSV" ici\n\n` +
                `üí° Le mod√®le contient des exemples pour vous guider !\n\n` +
                `‚ö†Ô∏è Note : Le lien du mod√®le est fictif. Cr√©ez votre propre Google Sheet avec les colonnes ci-dessus.`;
            
            alert(message);
            
            // Proposer aussi l'ajout manuel rapide
            setTimeout(() => {
                const useManual = confirm('Voulez-vous plut√¥t utiliser l\'ajout rapide int√©gr√© ?\n(Plus simple, pas de fichier √† g√©rer)');
                if (useManual) {
                    openQuickAddModal();
                }
            }, 500);
        }
        
        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.tsv,.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const fileText = event.target.result;
                    parseCSV(fileText);
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            let imported = 0;
            let errors = [];
            
            // D√©tecter le s√©parateur (virgule ou tabulation)
            const separator = csvText.includes('\t') ? '\t' : ',';
            
            // Commencer apr√®s la ligne d'en-t√™te (ligne 0)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parser la ligne avec le bon s√©parateur
                const values = line.split(separator).map(v => v.trim());
                
                const lastName = values[0];
                const firstName = values[1];
                const side = values[2];
                const gender = values[3];
                const isChild = values[4]?.toLowerCase() === 'oui';
                const diet = values[5];
                const allergy = values[6];
                const providerJob = values[7];
                
                // Cr√©er le nom complet
                const guestName = firstName && lastName ? `${firstName} ${lastName}` : (firstName || lastName);
                
                if (!guestName) continue;
                
                if (!gender || !['girl', 'boy', 'other', 'provider'].includes(gender)) {
                    errors.push(`Ligne ${i + 1}: Sexe invalide pour ${guestName}`);
                    continue;
                }
                
                if (gender !== 'provider' && !side) {
                    errors.push(`Ligne ${i + 1}: C√¥t√© manquant pour ${guestName}`);
                    continue;
                }
                
                // Ajouter l'invit√©
                if (!guests.includes(guestName)) {
                    guests.push(guestName);
                    imported++;
                }
            }
            
            renderGuestList();
            updateStats();
            
            let message = `‚úÖ ${imported} invit√©(s) import√©(s)`;
            if (errors.length > 0) {
                message += `\n\n‚ö†Ô∏è ${errors.length} erreur(s):\n${errors.slice(0, 3).join('\n')}`;
            }
            message += '\n\nüí° Glissez-d√©posez les invit√©s vers les places.';
            
            alert(message);
        }
        
        function exportGuestList() {
            // Sauvegarder les tables de l'espace actuel avant l'export
            spaces[currentSpace].tables = tables;
            
            const leftSpouse = document.getElementById('leftSpouseName').value.trim() || 'Mari√©(e) 1';
            const rightSpouse = document.getElementById('rightSpouseName').value.trim() || 'Mari√©(e) 2';
            const weddingDate = document.getElementById('weddingDate').value;
            const formattedDate = weddingDate ? new Date(weddingDate).toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            }) : 'Date non d√©finie';
            
            let text = `LISTE DES INVIT√âS PAR TABLE ET PAR ESPACE\n`;
            text += `Mariage de ${leftSpouse} et ${rightSpouse}\n`;
            text += `Date: ${formattedDate}\n\n`;
            text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            
            // Par espace
            Object.entries(spaces).forEach(([key, space]) => {
                if (space.tables.length === 0) return;
                
                text += `\n‚îÅ‚îÅ‚îÅ ${space.name.toUpperCase()} ‚îÅ‚îÅ‚îÅ\n`;
                text += `üìê Dimensions: ${space.realWidth}m √ó ${space.realHeight}m\n\n`;
                
                space.tables.forEach(table => {
                    const tableName = table.name || `Table ${table.number}`;
                    const occupiedSeats = table.guests.filter(g => g !== null).length;
                    
                    text += `${tableName.toUpperCase()}\n`;
                    text += `Capacit√©: ${table.seats} places | Occup√©es: ${occupiedSeats}\n`;
                    text += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    
                    table.guests.forEach((guest, i) => {
                        if (guest) {
                            const isProvider = table.guestGenders[i] === 'provider';
                            
                            if (isProvider) {
                                const job = table.guestProviderJob[i] || 'Non sp√©cifi√©';
                                text += `  ${i + 1}. ${guest} (PRESTATAIRE)\n`;
                                text += `     ‚îî‚îÄ M√©tier: ${job}\n`;
                            } else {
                                const side = table.guestSides[i] === 'left' ? leftSpouse : rightSpouse;
                                const genderMap = { 'girl': 'üëß Fille', 'boy': 'üë¶ Gar√ßon', 'other': 'üåü Autre' };
                                const gender = genderMap[table.guestGenders[i]] || '';
                                const diet = table.guestDiets[i] ? ` | R√©gime: ${table.guestDiets[i]}` : '';
                                const child = table.guestIsChild[i] ? ' | Enfant' : '';
                                text += `  ${i + 1}. ${guest}\n`;
                                text += `     ‚îî‚îÄ C√¥t√©: ${side} | ${gender}${child}${diet}\n`;
                            }
                        }
                    });
                    
                    text += `\n`;
                });
            });
            
            // Statistiques g√©n√©rales
            const allTables = Object.values(spaces).flatMap(s => s.tables);
            const totalSeats = allTables.reduce((sum, t) => sum + t.seats, 0);
            const assignedSeats = allTables.reduce((sum, t) => 
                sum + t.guests.filter(g => g !== null).length, 0);
            
            text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            text += `STATISTIQUES G√âN√âRALES\n`;
            text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            text += `Nombre total de tables: ${allTables.length}\n`;
            text += `Places totales: ${totalSeats}\n`;
            text += `Places occup√©es: ${assignedSeats}\n`;
            text += `Places libres: ${totalSeats - assignedSeats}\n`;
            text += `Taux de remplissage: ${Math.round((assignedSeats / totalSeats) * 100)}%\n\n`;
            
            // Par espace
            Object.entries(spaces).forEach(([key, space]) => {
                const tableCount = space.tables.length;
                const seats = space.tables.reduce((sum, t) => sum + t.seats, 0);
                const occupied = space.tables.reduce((sum, t) => 
                    sum + t.guests.filter(g => g !== null).length, 0);
                text += `${space.name}: ${tableCount} tables, ${occupied}/${seats} places\n`;
            });
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `liste-invites-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function openTableNameModal(table) {
            selectedTableForName = table;
            document.getElementById('tableNameInput').value = table.name || '';
            document.getElementById('tableNameModal').classList.add('active');
        }
        
        function closeTableNameModal() {
            document.getElementById('tableNameModal').classList.remove('active');
            selectedTableForName = null;
        }
        
        function saveTableName() {
            const name = document.getElementById('tableNameInput').value.trim();
            if (selectedTableForName) {
                selectedTableForName.name = name;
                renderTables();
            }
            closeTableNameModal();
        }
        
        function openQuickAddModal() {
            const leftSpouse = document.getElementById('leftSpouseName').value.trim() || 'Mari√©(e) 1';
            const rightSpouse = document.getElementById('rightSpouseName').value.trim() || 'Mari√©(e) 2';
            
            // Pr√©-remplir avec les pr√©noms des mari√©s dans le placeholder
            const placeholder = `Pr√©nom Nom, C√¥t√©, Sexe, Enfant, R√©gime, Allergie, M√©tier
Jean Dupont, ${leftSpouse}, boy, , , , 
Marie Martin, ${rightSpouse}, girl, , V√©g√©tarien, , 
Sophie Bernard, ${rightSpouse}, girl, oui, , , 
Lucas Petit, ${leftSpouse}, boy, oui, Sans gluten, , 
Alice Leroux, ${rightSpouse}, girl, , , Arachides, 
DJ Sound, , provider, , , , DJ
Photographe Pro, , provider, , , , Photographe`;
            
            document.getElementById('quickAddText').placeholder = placeholder;
            document.getElementById('quickAddText').value = '';
            
            // Mettre √† jour le guide
            document.getElementById('spouseNamesGuide').innerHTML = `
                <strong>üìã Format (s√©par√© par des virgules) :</strong><br>
                1. Pr√©nom Nom<br>
                2. C√¥t√© : <code>${leftSpouse}</code> ou <code>${rightSpouse}</code> (vide si prestataire)<br>
                3. Sexe : <code>girl</code>, <code>boy</code>, <code>other</code> ou <code>provider</code><br>
                4. Enfant : <code>oui</code> ou vide<br>
                5. R√©gime : texte libre ou vide<br>
                6. Allergie : texte libre ou vide<br>
                7. M√©tier : texte libre (si prestataire) ou vide
            `;
            
            document.getElementById('quickAddModal').classList.add('active');
        }
        
        function closeQuickAddModal() {
            document.getElementById('quickAddModal').classList.remove('active');
        }
        
        function processQuickAdd() {
            const text = document.getElementById('quickAddText').value.trim();
            if (!text) {
                alert('Veuillez entrer au moins un invit√©');
                return;
            }
            
            const leftSpouse = document.getElementById('leftSpouseName').value.trim() || 'Mari√©(e) 1';
            const rightSpouse = document.getElementById('rightSpouseName').value.trim() || 'Mari√©(e) 2';
            
            const lines = text.split('\n');
            let added = 0;
            let duplicates = 0;
            let errors = [];
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                // Parser la ligne CSV
                const parts = trimmedLine.split(',').map(p => p.trim());
                
                const name = parts[0];
                const sideInput = parts[1] || '';
                const gender = parts[2] || '';
                const isChild = parts[3]?.toLowerCase() === 'oui';
                const diet = parts[4] || '';
                const allergy = parts[5] || '';
                const providerJob = parts[6] || '';
                
                if (!name) return;
                
                // Convertir le pr√©nom du mari√© en left/right
                let side = '';
                if (sideInput) {
                    if (sideInput.toLowerCase() === leftSpouse.toLowerCase()) {
                        side = 'left';
                    } else if (sideInput.toLowerCase() === rightSpouse.toLowerCase()) {
                        side = 'right';
                    } else {
                        errors.push(`Ligne ${index + 1}: C√¥t√© "${sideInput}" invalide pour ${name}. Utilisez "${leftSpouse}" ou "${rightSpouse}"`);
                        return;
                    }
                }
                
                // Validation
                if (gender && !['girl', 'boy', 'other', 'provider'].includes(gender)) {
                    errors.push(`Ligne ${index + 1}: Sexe invalide pour ${name}`);
                    return;
                }
                
                if (gender && gender !== 'provider' && !side) {
                    errors.push(`Ligne ${index + 1}: C√¥t√© manquant pour ${name}`);
                    return;
                }
                
                if (!guests.includes(name)) {
                    guests.push(name);
                    
                    // Stocker les donn√©es compl√®tes
                    guestData[name] = {
                        side: side,
                        gender: gender,
                        isChild: isChild,
                        diet: diet,
                        allergy: allergy,
                        providerJob: providerJob
                    };
                    
                    added++;
                } else {
                    duplicates++;
                }
            });
            
            renderGuestList();
            updateStats();
            closeQuickAddModal();
            
            let message = `‚úÖ ${added} invit√©(s) ajout√©(s) !`;
            if (duplicates > 0) {
                message += `\n‚ö†Ô∏è ${duplicates} doublon(s) ignor√©(s)`;
            }
            if (errors.length > 0) {
                message += `\n\n‚ùå Erreurs (${errors.length}):\n${errors.slice(0, 3).join('\n')}`;
            }
            message += '\n\nüí° Glissez-d√©posez les invit√©s vers les places.\nLes informations seront pr√©-remplies !';
            
            alert(message);
        }
        
        // Initialisation
        initCanvas();
        renderGuestList();
        updateStats();
        updateAllSpaceStats();
    </script>
</body>
</html>